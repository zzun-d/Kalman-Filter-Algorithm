# 재귀필터

**신호 처리 분야에서 많이 사용되는 세 종류의 재귀 필터를 알아보자**

### 1. 평균 필터

우선 평균을 구하는 식을 재귀식으로 표현할 필요가 있습니다

$$\bar x_k = {{x_1 + x_2 + \cdots + x_k} \over k}$$
$$\bar x_{k-1} = {{x_1 + x_2 + \cdots+x_{k-1} \over k-1}}$$

위의 식의 양변에 k를 곱하고 k-1로 나눠주면

$${k \over k-1}\bar x_k = {{x_1 + x_2 + \cdots+x_{k-1} \over k-1}} + {x_k \over k-1}$$
이렇게 표현이 가능하고 오른쪽 변에 첫 항은 $\bar x_{k-1}$과 동일하므로 결과적으로
$$\bar x_k = {k-1 \over k}\bar x_{k-1} + {1 \over k}x_k$$
재귀식으로 표현할 수 있습니다

여기서 $\alpha = {k-1 \over k}$ 로 정의하면 아래와 같은 식이 만들어집니다.
$$\bar x_k = \alpha \bar x_{k-1} + (1-\alpha)x_k$$

이 식이 바로 평균 필터이며, 시간의 흐름에 따라 순차적으로 들어오는 데이터의 평균 계산에 유용하게 사용됩니다.
[_평균 필터 예제 바로가기_](./실습/AvgFilter.ipynb)

### 2. 이동평균 필터

평균필터를 이용하면 측정 데이터에서 잡음을 제거할 수 있습니다.
하지만 측정하려는 데이터가 시간에 따라 변하는 경우에는 다른 필터를 적용해야 합니다.
그 이유는 평균 필터는 데이터의 동적인 변화를 무시하고 하나의 값만 내놓기 때문입니다.
이를 해결하기 위해 고안된 필터가 이동평균 필터입니다.
$$\bar x_k = {x_{k-n+1}+x_{k-n+2}+\cdots+x_k \over n}$$
위 식이 이동평균 필터의 수식입니다.
수식의 의미를 살펴보면 $\bar x_k$는 $k-n+1$번째 데이터부터 $k$번째 데이터까지 총 n개 데이터의 평균을 의미하게 되며, 기존 평균필터의 $\bar x_k$의 의마와는 다릅니다.

마찬가지로 위 식을 재귀식으로 표현해 보겠습니다.
$$\bar x_{k-1} = {x_{k-n}+x_{k-n+1}+\cdots+x_{k-1} \over n}$$
$$\bar x_k - \bar x_{k-1} = {x_k - x_{k-n} \over n}$$
$$\bar x_k = \bar x_{k-1} + {x_k - x_{k-n} \over n}$$

위 식을 이용하여 이동평균 필터를 구현하기 위해서는 $x_{k-1}$부터 $x_{k-n}$까지의 데이터를 보관하면서 갱신해 줄 필요가 있습니다.
[_이동평균 필터 예제 바로가기_](./실습/MoveAvgFilter.ipynb)

### 3. 저주파 통과 필터

앞서 정리한 이동평균의 한계점은 잡음을 제거하면서 변화의 추이를 따라가는 것이 쉽지 않다는 것입니다.
실제로 예제에서 구현한 코드의 seed를 바꿔 여러번 반복해 돌려보면, 데이터의 변화 추이를 못따라가는 경우들이 발생합니다. 그 이유는 오래된 데이터와 최근 데이터에 동일한 가중치를 주기 때문입니다.

$$\begin{aligned} \bar x_k &= {x_{k-n+1} + x_{k-n+2} +\cdots + x_k  \over n} \\ \ \\ &= {1 \over n}x_{k-n+1} + {1\over n}x_{k-n+2} + \cdots + {1\over n}x_k \end{aligned}$$

수식으로 보니 더 쉽게 이해할 수 있습니다. 모두 $1\over n$의 가중치를 갖네요.

이처럼 모두 같은 가중치를 가지면 변화 추이를 따라가는 것이 어려운 이유는 뭘까요?

우리가 보통 측정하는 데이터는 일정한 측정 주기가 있는 이산형 데이터로 들어오지만, 실제적으론 연속형 데이터인 경우가 많습니다. 연속형 데이터의 특징은 다음 데이터 값은 직전 데이터값에서 크게 벗어나지 않았다는 것입니다. 그 말은 다음 데이터는 사실 직전 데이터 값과 유사하다 볼 수 있다는 것이죠. 결론적으로 값의 변화가 크게 일어나는 데이터에는 일정한 가중치를 부여하는 이동평균이 적절하지 않을 수 있습니다.

그래서 고안된 필터가 측정된 시점에 따라 가중치를 다르게주는 저주파 통과 필터입니다.

$$\bar x_k = \alpha \bar x_{k-1} + (1-\alpha)x_k ,\ \ \ 0 < \alpha < 1$$

위 필터의 이름은 1차 저주파 통과 필터입니다. 수식은 평균필터와 비슷하네요. 다만, 평균필터에서는 $\alpha$ 값이 k값에 따라 정해진 상수였다라는 것이 차이점이라 할 수 있겠네요. 또한, 저주파 통과 필터에서는 평균이 아닌 추정값이라는 용어를 사용합니다.

$$\bar x_{k-1} = \alpha \bar x_{k-2} + (1-\alpha)x_{k-1}$$
$$\bar x_{k-2} = \alpha \bar x_{k-3} + (1-\alpha)x_{k-2}$$

$\alpha$의 의미를 이해하기 위해 위 두 식을 기본식에 대입해 봅시다.

$$\begin{aligned} \bar x_k &= \alpha \bar x_{k-1} + (1-\alpha)x_k \\ \ \\ &=\alpha \{\alpha \bar x_{k-2} + (1-\alpha)x_{k-1} \} + (1-\alpha)x_k \\ \ \\ &= \alpha^2 \bar x_{k-2} + \alpha(1-\alpha)x_{k-1} + (1-\alpha)x_k \\ \ \\ &=\alpha ^2 \{\alpha \bar x_{k-3} + (1-\alpha)x_{k-2}\} + \alpha(1-\alpha)x_{k-1} + (1-\alpha)x_k \\ \ \\ &= \alpha^3 \bar x_{k-3} + \alpha ^2 (1-\alpha)x_{k-2} + \alpha(1-\alpha)x_{k-1} + (1-\alpha)x_k \end{aligned}$$

$\alpha$는 1보다 작은 상수이므로 측정 데이터의 계수 사이의 관계는 아래와 같습니다.
$$\alpha ^2 (1-\alpha) < \alpha(1-\alpha) < 1-\alpha$$

오래된 측정 데이터일수록 작은 계수가 곱해집니다. 즉 오래전 측정한 데이터일수록 추정값 계산에 반영되는 비중이 작아진다는 의미입니다.
[_저주파 통과 필터 예제 바로가기_](./실습/LowPassFilter.ipynb)
